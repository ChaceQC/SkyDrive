================================================================
项目名称：极速云存储系统 (SkyDrive Enterprise) 项目策划书
================================================================

1. 项目背景与目标
----------------------------------------------------------------
1.1 项目背景
随着数字化办公的普及，个人与企业产生的数据量呈指数级增长。传统的文件传输方式（如FTP、邮件附件、U盘）存在安全性低、传输速度慢、无法协同协作等痛点。我们需要构建一套安全、高效、可扩展的分布式文件存储系统。

1.2 项目目标
- [数据安全]：实现数据的加密存储与传输，确保数据不丢失、不泄露。
- [高效传输]：支持大文件断点续传、秒传（去重）、CDN加速。
- [多端同步]：提供Web端、PC客户端（Windows/Mac）、移动端，实现多端数据实时同步。
- [协同办公]：支持文件共享、权限管理及在线预览（Office/PDF/视频）。


2. 总体架构设计
----------------------------------------------------------------
本项目采用微服务架构，将元数据管理与文件块存储分离，以保证系统的高扩展性。

2.1 核心架构层级
(1) 接入层 (Gateway)
    - 负责负载均衡、SSL终端、API鉴权、限流熔断。

(2) 业务逻辑层 (Services)
    - 用户服务：注册、登录、OAuth2.0集成。
    - 元数据服务 (Metadata)：管理文件目录树、文件名、大小、属性。
    - 存储服务 (Block Store)：负责与底层对象存储（S3/MinIO/OSS）交互，处理文件切片。
    - 处理服务 (Processor)：异步处理图片压缩、视频转码、文档预览生成。

(3) 数据层 (Data)
    - 关系型数据库：存储用户信息及文件元数据。
    - NoSQL/缓存：Redis用于缓存热点数据及上传状态；ElasticSearch用于全文检索。
    - 对象存储：物理存储文件二进制流（Blob）。


3. 服务端功能详解 (Server-Side)
----------------------------------------------------------------
服务端是整个系统的“大脑”，提供RESTful API或gRPC接口。

3.1 用户与权限模块
- 多租户支持：支持企业/组织架构，部门隔离。
- RBAC权限控制：基于角色的权限控制（所有者、可编辑、仅查看、仅下载）。
- 空间配额管理：限制不同等级用户的存储空间和上传流量。

3.2 文件核心服务
- 文件上传 (核心)：
    * 分片上传：前端将大文件切割为4MB/片，并发上传。
    * 断点续传：记录上传进度，网络中断后可从断点继续。
    * 秒传 (Deduplication)：上传前计算文件Hash (MD5/SHA256)，若库中已存在相同Hash，则直接通过逻辑链接完成上传，无需物理传输。
- 文件下载：支持流式下载、打包下载（多文件压缩为Zip后下载）。
- 回收站机制：软删除文件，保留30天后自动清除。

3.3 文件处理与预览
- Office在线预览：集成OnlyOffice或LibreOffice转换服务。
- 多媒体处理：视频自动转码（HLS/M3U8）以适应网页播放；图片生成缩略图。

3.4 分享与外链
- 公开/私密分享：生成分享链接，支持设置提取码、有效期、下载次数限制。
- WebDAV支持：支持标准WebDAV协议，允许用户挂载为本地磁盘。


4. 客户端功能详解 (Client-Side)
----------------------------------------------------------------
客户端注重用户体验（UX）和系统级交互。

4.1 Web端 (浏览器)
- 文件资源管理器：仿Windows文件管理器的UI，支持拖拽上传、右键菜单、框选。
- 传输列表：可视化的上传/下载进度面板，支持暂停、取消、重试。
- 在线查看器：内置PDF.js、Video.js等播放器。

4.2 PC桌面端 (Windows/macOS/Linux)
- 虚拟文件系统 (Virtual Drive)：
    * 使用FUSE (Linux/Mac) 或 Dokan/WinFSP (Windows) 技术，将云盘挂载为本地“Z盘”。
    * 按需加载 (Files On-Demand)：仅下载文件元数据，用户双击打开时才流式下载内容，节省本地硬盘空间。
- 自动备份/同步：指定本地文件夹与云端文件夹双向或单向同步。
- 系统托盘集成：快速查看通知、最近文件。

4.3 移动端 (iOS/Android)
- 相册自动备份：后台静默备份手机照片/视频。
- 文件离线：将重要文件标记为“离线可用”。


5. 技术选型建议
----------------------------------------------------------------
为了保证性能和开发效率，推荐以下技术栈：

- 后端语言：Python
  理由：好用

- 前端框架：React + TypeScript
  理由：组件化强，生态丰富，适合复杂的文件管理UI。

- 桌面端：Electron 或 Tauri
  理由：Electron开发快；Tauri包体积小，安全性高。

- 数据库：MySQL 8.0
  理由：存储元数据，事务支持好。

- 缓存/队列：Redis + RabbitMQ/Kafka
  理由：Redis用于Session和上传进度；MQ用于削峰填谷（如视频转码任务）。

- 对象存储：MinIO (自建) 或 AWS S3
  理由：MinIO兼容S3协议，适合私有化部署，性能强劲。

- 传输协议：HTTP/2 + gRPC
  理由：HTTP/2提升Web端加载速度，gRPC用于微服务间通讯。


6. 数据库设计概要 (核心表结构)
----------------------------------------------------------------
6.1 sys_user (用户表)
字段：user_id (主键), username, password_hash, quota_total, quota_used.

6.2 file_meta (用户文件索引表)
此表仅存储“文件视图”，不存储物理地址，实现类似Linux硬链接的逻辑。
字段：
- id (主键)
- user_id (外键，归属用户)
- parent_id (父文件夹ID，0为根目录)
- file_name (文件名)
- is_folder (是否为文件夹)
- file_hash (指向物理文件的Hash值，关键字段)

6.3 file_store (物理文件表)
此表存储实际的物理文件信息，用于“秒传”去重。
字段：
- file_hash (主键，唯一标识)
- real_path (对象存储中的路径，如 /bucket/2026/01/uuid.dat)
- file_size (物理大小)
- ref_count (引用计数，当为0时才真正从对象存储删除)


7. 非功能性需求 (NFR)
----------------------------------------------------------------
1. 安全性：
   - 全站HTTPS传输。
   - 文件切片在客户端加密后再上传（可选的高级隐私模式）。
   - 防止ID遍历攻击（使用Snowflake ID或UUID）。

2. 高可用性：
   - 服务无状态设计，支持K8s水平扩容。
   - 数据库主从复制，故障自动切换。

3. 性能指标：
   - 上传/下载速度主要受限于带宽，内网部署应跑满千兆网络。
   - 支持单目录下存储 10万+ 文件不卡顿。


8. 项目开发阶段规划
----------------------------------------------------------------
- 完成基础的用户注册登录。
- 实现Web端文件的上传（含分片）、下载、删除、重命名。
- 搭建MinIO和MySQL基础架构。

- 实现秒传、断点续传功能。
- 实现图片/视频的在线预览。
- 开发分享链接功能。

- 开发PC客户端（Electron），实现虚拟挂载或同步文件夹。
- 开发Android/iOS基础版本。
